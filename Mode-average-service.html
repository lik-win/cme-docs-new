<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>模式平均服务</title>
    <link rel="stylesheet" href="/demo.css" />
    <link rel="stylesheet" href="/libs/layui.css" />
    <script type="text/javascript" src="/libs/layui.js"></script>
    <script type="text/javascript" src="/libs/cme2d.js"></script>
    <script type="text/javascript" src="/libs/cme-core.umd.cjs"></script>
    <script src="/libs/dayjs.js"></script>
    <script src="/libs/axios.js"></script>
  </head>
  <body>
      <div id="map"></div>
      <!-- <div class="localDataImport">
        <div class="wrapper">
          <div class="layui-inline">
          <label class="layui-form-label">开始时间</label>
          <div class="layui-input-inline">
            <input
              type="text"
              class="layui-input"
              id="ID-laydate-demo"
              placeholder="yyyy-MM-dd HH:mm:ss"
            />
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label">结束时间</label>
          <div class="layui-input-inline">
            <input
              type="text"
              class="layui-input"
              id="ID-laydate-demo1"
              placeholder="yyyy-MM-dd HH:mm:ss"
            />
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label">起报时间</label>
          <div class="layui-input-inline">
            <input
              type="text"
              class="layui-input"
              id="ID-laydate-demo2"
              placeholder="yyyy-MM-dd HH:mm:ss"
            />
          </div>
        </div>
        <button id="search" class="layui-btn layui-btn-primary layui-bg-blue" >查询</button>
        </div>
      </div> -->
      <style>
        .localDataImport {
          position: fixed;
          bottom: 0;
          padding: 30px;
          background-color: cadetblue;
          z-index: 9;
        }
        .wrapper{
          display: flex;
          flex-direction: column;
          gap:24px;
        }
     
      </style>
    <script type="text/javascript">
      var mapView=null
      const min = -30
      const max = 30
      const step = 5
      const apiInfo = {
        url: 'http://10.40.88.119:11000/cmes-base-gridstat/gridstat/mode/getStaTiff',
        args: {
          startTime: {
            value: '20241206080000',
            type: 'string',
            required: true,
            desc: '开始时间',
          },
          endTime: {
            value: '20241206140000',
            type: 'string',
            required: true,
            desc: '结束时间',
          },
          dateTime: {
            value: '20241205080000',
            type: 'string',
            required: true,
            desc: '起报时间',
          },
          element: {
            value: 'tem',
            type: 'string',
            required: true,
            desc: '模式数据',
          },
          modeType: {
            value: 'SCMOC',
            type: 'string',
            required: true,
            desc: '模式类型',
          },
          type: {
            value: 'n',
            type: 'string',
            required: false,
            desc: '类型',
          }
        }
      }


      const { Map: CMEMap, View, source, layer, Feature } = window.CME2D
      let map, vectorS
      const { blendLayers, style, CMEStyle } = window.CMECore
      const {
        Point,
            LineString,
            Polygon,
            Circle: GeomCircle,
          } = window.CME2D.geom
          const { GeoJSON } = window.CME2D.format 
          const { Circle, Fill, Stroke, Style, Text, Icon } = window.CME2D.style
          const { Vector: VectorLayer } = window.CME2D.layer
          const FillPattern =  CMEStyle.cme_style_FillPattern
          let startTime=apiInfo.args.startTime.value
          let endTime=apiInfo.args.endTime.value
          let dateTime=apiInfo.args.dateTime.value
          var element=apiInfo.args.element.value
          function initMap(mapEl) {
            vectorS = new source.Vector({
              wrapX: true,
            })
            const map = new CMEMap({
              target: mapEl, //挂载实例
              layers: [
                new layer.Tile({
                  source: new source.XYZ({
                    url: 'http://10.0.54.106:8080/windy/{z}/{x}/{y}.png', // 内网地址
                  }),
                }),
                new VectorLayer({
                  source: vectorS,
                  name: 'Point',
                }),
              ],
              view: new View({
                //地图视图
                center: [106, 35],
                projection: 'EPSG:4326',
                zoom: 5,
                wrapX: true,
              }), //地图设置
              controls: [], //取消地图操作
            })
            return map
          }
          layui.use(function () {
        var laydate = layui.laydate
        // 渲染
        laydate.render({
          elem: '#ID-laydate-demo',
          type:'datetime',
          value:dayjs(startTime).format('YYYY-MM-DD HH:00:00'),
          done: (val) => {
            console.log(val,'val')
            startTime=dayjs(val).format('YYYYMMDDHH0000')
          },
        })
        laydate.render({
          elem: '#ID-laydate-demo1',
          type:'datetime',
          value:dayjs(endTime).format('YYYY-MM-DD HH:00:00'),
          done: (val) => {
            endTime=dayjs(val).format('YYYYMMDDHH0000')
          },
        })
        laydate.render({
          elem: '#ID-laydate-demo2',
          type:'datetime',
          value:dayjs(dateTime).format('YYYY-MM-DD HH:00:00'),
          done: (val) => {
            dateTime=dayjs(val).format('YYYYMMDDHH0000')
          },
        })
      })
       

  function handleQueryString(params) {
      let str = ''
      for (let key in params) {
        str += `${key}=${params[key]}&`
      }
      return str.slice(0, -1)
    }

  const getTifUrl = (params) => {
    axios
      .get(apiInfo.url+`?${handleQueryString(params)}`)
      .then((res) => {
        let url = res.data.data
        singKleLayer(mapView, url)
      })
  }
  
  function singKleLayer(map, url) {
       let layer=map.getAllLayers().find((datas)=>datas.values_.layerName == 'cogtifLayer')
       if(layer){
         map.removeLayer(layer)
       }
        const params = getsingleConfig()
        tiffLayers = new blendLayers(map, {
          url: url,
        })
        //绘制色斑图
        tiffLayers._render(params).then((object) => {
          tiffLayers.addCogeoLayer(params).then((layer) => {
            map.addLayer(layer)
          })
        })
      }
      function getsingleConfig() {
        let params = {
          layerName: 'cogtifLayer',
          opacity: 1,
          interpolation: 'linear', // 渐变 linear  区间 nearest  网格 grid
          colors: [
              [-70, [115, 70, 105, 1]],
              [-55, [202, 172, 195, 1]],
              [-40, [162, 70, 145, 1]],
              [-25, [143, 89, 169, 1]],
              [-15, [157, 219, 217, 1]],
              [-8, [106, 191, 181, 1]],
              [-4, [100, 166, 189, 1]],
              [0, [93, 133, 198, 1]],
              [1, [68, 125, 99, 1]],
              [10, [128, 147, 24, 1]],
              [21, [243, 183, 4, 1]],
              [30, [232, 83, 25, 1]],
              [47, [71, 14, 0, 1]]
            ],
        }
        return params
      }
        window.onload = function () {
            const mapEl = document.querySelector('#map')
            mapView = initMap(mapEl)
            mapView.once('postrender', function () {
              let params = {
                dateTime:dateTime,
                element:'tem',
                startTime:startTime,
                endTime:endTime,
                modeType:'SCMOC',
                type:'n',
              }
              onRun(params)
              document.getElementById('search').onclick=function(val){
                 console.log(startTime,endTime,'val')
                 let params = {
                    dateTime:dateTime,
                    element:'tem',
                    startTime:startTime,
                    endTime:endTime,
                    modeType:'SCMOC',
                    type:'n',
                  }
                 onRun(params)
              }
            })
          }
        
      function onRun(params) {
        getTifUrl(params)
      }
    </script>
    <script src="/libs/message.js"></script>
  </body>
</html>
