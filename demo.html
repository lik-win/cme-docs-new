<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>地图测距</title>
  <link rel="stylesheet" href="/demo.css" />
</head>

<body>
  <div id="map"></div>
  <div class="panel">
    <button id="startEl">开始测距</button>
    <button id="endEl">结束测距</button>
  </div>
  <script type="text/javascript" src="/libs/cme2d.js"></script>
  <script type="text/javascript">
    const { Map: CMEMap, View, source, layer, Overlay, interaction, sphere, geom, Observable } = window.CME2D;

    // 获取长度
    function formatLength(line) {
      const lonlats = line.getCoordinates();
      let length = 0;
      lonlats.forEach((v, i) => {
        if (!i) return;
        length += sphere.getDistance(lonlats[i - 1], lonlats[i]);
      });
      if (length > 1000) {
        return `${(length / 1000).toFixed(1)} km`;
      }
      return `${Math.round(length)} m`;
    };

    // 创建矢量数据源和图层
    const sourceV = new source.Vector({ wrapX: false });
    const layerV = new layer.Vector({ source: sourceV });
    function initMap(mapEl) {
      const map = new CMEMap({
        target: mapEl,//挂载实例
        layers: [
          new layer.Tile({
            source: new source.XYZ({
              url: 'http://10.0.54.106:8080/windy/{z}/{x}/{y}.png'   // 内网地址
              // url: 'http://111.205.114.224:8080/windy/{z}/{x}/{y}.png'   // 外网地址
            })
          }),
          layerV
        ],
        view: new View({ //地图视图
          center: [106, 35],
          projection: "EPSG:4326",
          zoom: 5,
          wrapX: true,
        }),//地图设置
        controls: [],//取消地图操作
      });
      return map;
    }

    let mapObj = null;
    window.onload = function () {
      const mapEl = document.querySelector('#map');
      mapObj = initMap(mapEl);
    }
    let draw;

    function bindDrawEvent() {
      if (!draw) return;
      let sketch = null;
      draw.on('drawstart', function (evt) {
        sketch = evt.feature;
        let tooltipCoord = evt.coordinate;

        listener = sketch.getGeometry().on('change', function (evt) {
          const geom = evt.target;
          const output = formatLength(geom);
          tooltipCoord = geom.getLastCoordinate();
          measureTooltipEl.innerHTML = output;
          measureTooltip.setPosition(tooltipCoord);
        });
      });
      draw.on('drawend', function () {
        measureTooltipEl.className = 'ol-tooltip ol-tooltip-static';
        measureTooltip.setOffset([0, -7]);
        sketch = null;
        measureTooltipEl = null;
        createMeasureTooltip();
        Observable.unByKey(listener);
      });
    }

    let measureTooltipEl = null;
    let measureTooltip = null;
    // 添加测量提示
    function createMeasureTooltip() {
      if (measureTooltipEl) {
        measureTooltipEl.remove();
      }
      measureTooltipEl = document.createElement('div');
      measureTooltipEl.className = 'ol-tooltip ol-tooltip-measure';
      measureTooltip = new Overlay({
        element: measureTooltipEl,
        offset: [0, -15],
        positioning: 'bottom-center',
        stopEvent: false,
        insertFirst: false,
      });
      mapObj.addOverlay(measureTooltip);
    }

    // 开始测距
    document.querySelector('#startEl').addEventListener('click', e => {
      if (draw) return;
      createMeasureTooltip();
      draw = new interaction.Draw({ source: sourceV, type: 'LineString' });
      bindDrawEvent();
      mapObj.addInteraction(draw);
    });

    // 结束测距
    document.querySelector('#endEl').addEventListener('click', e => {
      if (!draw) return;
      mapObj.removeInteraction(draw);
      sourceV.clear();
      mapObj.getOverlays().forEach(o => mapObj.removeOverlay(o));
    });
  </script>
</body>

</html>