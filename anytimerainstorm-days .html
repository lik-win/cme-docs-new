<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>任意时间段暴雨日数插值服务</title>
    <link rel="stylesheet" href="/demo.css" />
    <link rel="stylesheet" href="/libs/layui.css" />
    <script type="text/javascript" src="/libs/layui.js"></script>
    <script type="text/javascript" src="/libs/cme2d.js"></script>
    <script type="text/javascript" src="/libs/cme-core.umd.cjs"></script>
    <script src="/libs/dayjs.js"></script>
    <script src="/libs/axios.js"></script>
  </head>
  <body>
      <div id="map"></div>
      <!-- <div class="localDataImport">
        <div class="wrapper">
          <div class="layui-inline">
          <label class="layui-form-label">开始时间</label>
          <div class="layui-input-inline">
            <input
              type="text"
              class="layui-input"
              id="ID-laydate-demo"
              placeholder="yyyy-MM-dd HH:mm:ss"
            />
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label">结束时间</label>
          <div class="layui-input-inline">
            <input
              type="text"
              class="layui-input"
              id="ID-laydate-demo1"
              placeholder="yyyy-MM-dd HH:mm:ss"
            />
          </div>
        </div>
        <button id="search" class="layui-btn layui-btn-primary layui-bg-blue" >查询</button>
        </div>
      </div> -->
      <style>
        .localDataImport {
          position: fixed;
          bottom: 0;
          padding: 30px;
          background-color: cadetblue;
          z-index: 9;
        }
        .wrapper{
          display: flex;
          flex-direction: column;
          gap:24px;
        }
     
      </style>
    <script type="text/javascript">
      var mapView=null
      const min = -30
      const max = 30
      const step = 5
      const apiInfo = {
        url: 'http://10.40.88.119:11000/cmes-base-pointinterpolat/point/manage/getPointMap',
        args: {
          start: {
            value: '20240728080000',
            type: 'string',
            required: true,
            desc: '开始时间',
          },
          end: {
            value: '20240814080000',
            type: 'string',
            required: true,
            desc: '结束时间',
          },
          element: {
            value: 'preNum50_day_0808',
            type: 'string',
            required: true,
            desc: '要素',
          },
          staType: {
            value: 'countrySta',
            type: 'string',
            required: true,
            desc: '站点类型',
          }
        },
      }
      const { Map: CMEMap, View, source, layer, Feature } = window.CME2D
      let map, vectorS
      const { blendLayers, style, CMEStyle } = window.CMECore
      const {
        Point,
            LineString,
            Polygon,
            Circle: GeomCircle,
          } = window.CME2D.geom
          const { GeoJSON } = window.CME2D.format 
          const { Circle, Fill, Stroke, Style, Text, Icon } = window.CME2D.style
          const { Vector: VectorLayer } = window.CME2D.layer
          const FillPattern =  CMEStyle.cme_style_FillPattern
          let startTime=apiInfo.args.start.value
          let endTime=apiInfo.args.end.value
          var element=apiInfo.args.element.value
          function initMap(mapEl) {
            vectorS = new source.Vector({
              wrapX: true,
            })
            const map = new CMEMap({
              target: mapEl, //挂载实例
              layers: [
                new layer.Tile({
                  zIndex:99,
                  source: new source.XYZ({
                    url: 'http://10.0.54.106:8080/windy/{z}/{x}/{y}.png', // 内网地址
                  }),
                }),
                new VectorLayer({
                  source: vectorS,
                  name: 'Point',
                }),
              ],
              view: new View({
                //地图视图
                center: [106, 35],
                projection: 'EPSG:4326',
                zoom: 5,
                wrapX: true,
              }), //地图设置
              controls: [], //取消地图操作
            })
            return map
          }
          layui.use(function () {
        var laydate = layui.laydate
        // 渲染
        laydate.render({
          elem: '#ID-laydate-demo',
          type:'datetime',
          value:dayjs(startTime).format('YYYY-MM-DD HH:00:00'),
          done: (val) => {
            console.log(val,'val')
            startTime=dayjs(val).format('YYYYMMDDHH0000')
          },
        })
        laydate.render({
          elem: '#ID-laydate-demo1',
          type:'datetime',
          value:dayjs(endTime).format('YYYY-MM-DD HH:00:00'),
          done: (val) => {
            endTime=dayjs(val).format('YYYYMMDDHH0000')
          },
        })
      })
       

  function handleQueryString(params) {
      let str = ''
      for (let key in params) {
        str += `${key}=${params[key]}&`
      }
      return str.slice(0, -1)
    }
  const getTifUrl = (paramsD) => {
    let params={
      start: paramsD.start,
      end: paramsD.end,
      staType: paramsD.staType,
      element: paramsD.element,
    }
    axios
      .get(apiInfo.url+`?${handleQueryString(params)}`)
      .then((res) => {
        let url = res.data.data
        if (window.postResult) {
          window.postResult(res.data)
        }
        singKleLayer(mapView, url)
      })
  }

 
  function singKleLayer(map, url) {
       let layer=map.getAllLayers().find((datas)=>datas.values_.layerName == 'cogtifLayer')
       if(layer){
         map.removeLayer(layer)
       }
        const params = getsingleConfig()
        tiffLayers = new blendLayers(map, {
          url: url,
        })
        //绘制色斑图
        tiffLayers._render(params).then((object) => {
          tiffLayers.addCogeoLayer(params).then((layer) => {
            map.addLayer(layer)
          })
        })
      }
      function getsingleConfig() {
        let params = {
          layerName: 'cogtifLayer',
          opacity: 0.8,
          interpolation: 'nearest', // 渐变 linear  区间 nearest  网格 grid
          colors: [
        [0,[255,255,255,0]],
        [0.5,[200,253,214,1]],
        [2.5,[150,243,148,1]],
        [4.5,[114,221,248,1]],
        [6.5,[106,166,255,1]],
        [8.5,[0,113,238,1]],
        ],
        }
        return params
      }

      function getTextConfig() {
        let params = {
          layerName: 'textLayer',
          type: 'grid',
          layerName: 'textLayer', //文本图层的图层名字,默认是栅格数据id名称加上_Text
          precision: 1, //格网数据显示的小数点的精度
          opacity: 1, //透明度
          zIndex: 200, //图层层级
          distanceArrow: 80, //距离
          textStyle: {
            //   //文本样式
            Style: {
              text: {
                Text: {
                  font: '18px Calibri,sans-serif',
                  fill: {
                    Fill: {
                      color: '#000000',
                    },
                  },
                  stroke: {
                    Stroke: {
                      color: '#ffffff',
                      width: 4,
                    },
                  },
                },
              },
            },
          },
        }

        return params
      }

        window.onload = function () {
            const mapEl = document.querySelector('#map')
            mapView = initMap(mapEl)
            mapView.once('postrender', function () {
              let params = {
                start: apiInfo.args.start.value,
                end: apiInfo.args.end.value,
                staType: apiInfo.args.staType.value,
                element:apiInfo.args.element.value,
              }
              onRun(params)
            })
          }
        
      function onRun(params) {
        getTifUrl(params)
      }
    </script>
    <script src="/libs/message.js"></script>
  </body>
</html>
